# CLI Distribution Skill

A comprehensive guide for packaging and distributing Go CLI applications across all platforms.

## When to Use This Skill

- Releasing Go CLI tools to users
- Setting up automated release pipelines
- Creating Homebrew, AUR, Scoop, or Nix packages
- Cross-platform binary distribution
- Version management and changelogs

---

## GoReleaser Configuration

GoReleaser automates builds, packaging, and publishing.

### Basic `.goreleaser.yaml`

```yaml
version: 2

project_name: today

before:
  hooks:
    - go mod tidy
    - go generate ./...

builds:
  - id: today
    main: ./cmd/today
    binary: today
    env:
      - CGO_ENABLED=0
    goos:
      - linux
      - darwin
      - windows
    goarch:
      - amd64
      - arm64
    ldflags:
      - -s -w
      - -X main.version={{.Version}}
      - -X main.commit={{.Commit}}
      - -X main.date={{.Date}}

archives:
  - id: default
    format: tar.gz
    name_template: "{{ .ProjectName }}_{{ .Version }}_{{ .Os }}_{{ .Arch }}"
    format_overrides:
      - goos: windows
        format: zip
    files:
      - README.md
      - LICENSE
      - completions/*

checksum:
  name_template: "checksums.txt"

snapshot:
  version_template: "{{ incpatch .Version }}-next"

changelog:
  sort: asc
  filters:
    exclude:
      - "^docs:"
      - "^test:"
      - "^chore:"
  groups:
    - title: Features
      regexp: "^feat:"
    - title: Bug Fixes
      regexp: "^fix:"
    - title: Others
      order: 999

release:
  github:
    owner: your-username
    name: today
  draft: false
  prerelease: auto
  name_template: "v{{.Version}}"
```

### Homebrew Integration

Add to `.goreleaser.yaml`:

```yaml
brews:
  - name: today
    repository:
      owner: your-username
      name: homebrew-tap
      token: "{{ .Env.HOMEBREW_TAP_TOKEN }}"
    directory: Formula
    homepage: "https://github.com/your-username/today"
    description: "Terminal productivity dashboard"
    license: "MIT"
    install: |
      bin.install "today"
      # Install shell completions
      bash_completion.install "completions/today.bash" => "today"
      zsh_completion.install "completions/today.zsh" => "_today"
      fish_completion.install "completions/today.fish"
    test: |
      system "#{bin}/today", "--version"
```

### Scoop Integration

```yaml
scoops:
  - name: today
    repository:
      owner: your-username
      name: scoop-bucket
    homepage: "https://github.com/your-username/today"
    description: "Terminal productivity dashboard"
    license: MIT
```

### AUR Integration

```yaml
aurs:
  - name: today-bin
    homepage: "https://github.com/your-username/today"
    description: "Terminal productivity dashboard"
    maintainers:
      - "Your Name <your@email.com>"
    license: MIT
    private_key: "{{ .Env.AUR_SSH_KEY }}"
    git_url: "ssh://aur@aur.archlinux.org/today-bin.git"
```

---

## GitHub Actions Workflow

### `.github/workflows/release.yml`

```yaml
name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write
  packages: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      - name: Run tests
        run: go test -v ./...

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: "~> v2"
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
```

### CI Workflow (`.github/workflows/ci.yml`)

```yaml
name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-go@v5
        with:
          go-version: "1.22"
      
      - name: Test
        run: go test -race -coverprofile=coverage.txt ./...
      
      - name: Lint
        uses: golangci/golangci-lint-action@v4

  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-go@v5
        with:
          go-version: "1.22"
      
      - name: Build
        run: go build -v ./...
      
      - name: GoReleaser Check
        uses: goreleaser/goreleaser-action@v6
        with:
          args: check
```

---

## Package Manager Setup

### Homebrew Tap Repository

Create `homebrew-tap` repository with structure:

```
homebrew-tap/
├── Formula/
│   └── today.rb    # Auto-generated by GoReleaser
└── README.md
```

Manual formula (if not using GoReleaser):

```ruby
# Formula/today.rb
class Today < Formula
  desc "Terminal productivity dashboard"
  homepage "https://github.com/your-username/today"
  version "1.0.0"
  license "MIT"

  on_macos do
    if Hardware::CPU.arm?
      url "https://github.com/your-username/today/releases/download/v1.0.0/today_1.0.0_darwin_arm64.tar.gz"
      sha256 "abc123..."
    else
      url "https://github.com/your-username/today/releases/download/v1.0.0/today_1.0.0_darwin_amd64.tar.gz"
      sha256 "def456..."
    end
  end

  on_linux do
    if Hardware::CPU.arm?
      url "https://github.com/your-username/today/releases/download/v1.0.0/today_1.0.0_linux_arm64.tar.gz"
      sha256 "ghi789..."
    else
      url "https://github.com/your-username/today/releases/download/v1.0.0/today_1.0.0_linux_amd64.tar.gz"
      sha256 "jkl012..."
    end
  end

  def install
    bin.install "today"
  end

  test do
    system "#{bin}/today", "--version"
  end
end
```

### AUR PKGBUILD

```bash
# PKGBUILD
pkgname=today-bin
pkgver=1.0.0
pkgrel=1
pkgdesc="Terminal productivity dashboard"
arch=('x86_64' 'aarch64')
url="https://github.com/your-username/today"
license=('MIT')
provides=('today')
conflicts=('today')

source_x86_64=("${url}/releases/download/v${pkgver}/today_${pkgver}_linux_amd64.tar.gz")
source_aarch64=("${url}/releases/download/v${pkgver}/today_${pkgver}_linux_arm64.tar.gz")

sha256sums_x86_64=('SKIP')
sha256sums_aarch64=('SKIP')

package() {
    install -Dm755 today "${pkgdir}/usr/bin/today"
    install -Dm644 README.md "${pkgdir}/usr/share/doc/${pkgname}/README.md"
    install -Dm644 LICENSE "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE"
}
```

Publish to AUR:

```bash
# Clone AUR repo
git clone ssh://aur@aur.archlinux.org/today-bin.git
cd today-bin

# Add PKGBUILD
cp /path/to/PKGBUILD .

# Generate .SRCINFO
makepkg --printsrcinfo > .SRCINFO

# Commit and push
git add PKGBUILD .SRCINFO
git commit -m "Update to version 1.0.0"
git push
```

### Scoop Bucket

Create `scoop-bucket` repository:

```json
// bucket/today.json
{
  "version": "1.0.0",
  "description": "Terminal productivity dashboard",
  "homepage": "https://github.com/your-username/today",
  "license": "MIT",
  "architecture": {
    "64bit": {
      "url": "https://github.com/your-username/today/releases/download/v1.0.0/today_1.0.0_windows_amd64.zip",
      "hash": "sha256:abc123..."
    },
    "arm64": {
      "url": "https://github.com/your-username/today/releases/download/v1.0.0/today_1.0.0_windows_arm64.zip",
      "hash": "sha256:def456..."
    }
  },
  "bin": "today.exe",
  "checkver": "github",
  "autoupdate": {
    "architecture": {
      "64bit": {
        "url": "https://github.com/your-username/today/releases/download/v$version/today_$version_windows_amd64.zip"
      },
      "arm64": {
        "url": "https://github.com/your-username/today/releases/download/v$version/today_$version_windows_arm64.zip"
      }
    }
  }
}
```

### Nix Flake

```nix
# flake.nix
{
  description = "Terminal productivity dashboard";

  inputs = {
    nixpkgs.url = "github:NixOS/nixpkgs/nixos-unstable";
    flake-utils.url = "github:numtide/flake-utils";
  };

  outputs = { self, nixpkgs, flake-utils }:
    flake-utils.lib.eachDefaultSystem (system:
      let
        pkgs = nixpkgs.legacyPackages.${system};
      in
      {
        packages.default = pkgs.buildGoModule {
          pname = "today";
          version = "1.0.0";
          src = ./.;
          vendorHash = "sha256-AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=";
          
          ldflags = [
            "-s" "-w"
            "-X main.version=1.0.0"
          ];

          meta = with pkgs.lib; {
            description = "Terminal productivity dashboard";
            homepage = "https://github.com/your-username/today";
            license = licenses.mit;
            maintainers = [ ];
          };
        };

        devShells.default = pkgs.mkShell {
          buildInputs = with pkgs; [
            go_1_22
            gopls
            golangci-lint
          ];
        };
      });
}
```

---

## Shell Completions

### Generate Completions

```go
// cmd/today/completions.go
package main

import (
    "os"
    
    "github.com/spf13/cobra"
)

func init() {
    rootCmd.AddCommand(completionCmd)
}

var completionCmd = &cobra.Command{
    Use:   "completion [bash|zsh|fish|powershell]",
    Short: "Generate completion script",
    Args:  cobra.ExactArgs(1),
    Run: func(cmd *cobra.Command, args []string) {
        switch args[0] {
        case "bash":
            rootCmd.GenBashCompletion(os.Stdout)
        case "zsh":
            rootCmd.GenZshCompletion(os.Stdout)
        case "fish":
            rootCmd.GenFishCompletion(os.Stdout, true)
        case "powershell":
            rootCmd.GenPowerShellCompletionWithDesc(os.Stdout)
        }
    },
}
```

### Include in Release

```yaml
# .goreleaser.yaml
before:
  hooks:
    - mkdir -p completions
    - go run ./cmd/today completion bash > completions/today.bash
    - go run ./cmd/today completion zsh > completions/today.zsh
    - go run ./cmd/today completion fish > completions/today.fish

archives:
  - files:
      - completions/*
```

---

## Version Embedding

### `cmd/today/version.go`

```go
package main

import (
    "fmt"
    "runtime"
)

// Set via ldflags
var (
    version = "dev"
    commit  = "none"
    date    = "unknown"
)

func printVersion() {
    fmt.Printf("today %s\n", version)
    fmt.Printf("  commit: %s\n", commit)
    fmt.Printf("  built:  %s\n", date)
    fmt.Printf("  go:     %s\n", runtime.Version())
}
```

---

## Release Checklist

### Before Release

- [ ] Update CHANGELOG.md
- [ ] Run full test suite: `go test -race ./...`
- [ ] Run linter: `golangci-lint run`
- [ ] Test build locally: `goreleaser build --snapshot --clean`
- [ ] Update README if needed
- [ ] Ensure CI is green

### Create Release

```bash
# Tag the release
git tag -a v1.0.0 -m "Release v1.0.0"
git push origin v1.0.0

# GoReleaser runs automatically via GitHub Actions
```

### After Release

- [ ] Verify GitHub release created
- [ ] Test installation: `brew install your-username/tap/today`
- [ ] Verify AUR package (if applicable)
- [ ] Announce on social media / Hacker News / Reddit

---

## Installation Instructions Template

Include in README:

```markdown
## Installation

### Homebrew (macOS/Linux)
```bash
brew install your-username/tap/today
```

### AUR (Arch Linux)
```bash
yay -S today-bin
```

### Scoop (Windows)
```bash
scoop bucket add your-username https://github.com/your-username/scoop-bucket
scoop install today
```

### Nix
```bash
nix run github:your-username/today
```

### Go Install
```bash
go install github.com/your-username/today/cmd/today@latest
```

### Manual Download
Download from [GitHub Releases](https://github.com/your-username/today/releases)
```
```

---

## Quick Reference

```bash
# Local build
goreleaser build --snapshot --clean

# Full release (dry run)
goreleaser release --snapshot --clean

# Actual release (triggered by tag)
git tag -a v1.0.0 -m "Release v1.0.0"
git push origin v1.0.0

# Validate config
goreleaser check

# Generate changelog
goreleaser changelog
```
